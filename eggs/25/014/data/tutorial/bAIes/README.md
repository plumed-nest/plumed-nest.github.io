# Tutorial for ensemble prediction with bAIes

<p align="center">
  <img src="baies_ill.png" width="800">
</p>

These are the steps to do ensemble modelling using Alphafold-2 (or Colabfold) information.
Each step of the procedure will be carried out in a separate directory.

## 0. Inputs

Prior to making an ensemble, a structure prediction must be performed using [Alphafold-2](https://github.com/google-deepmind/alphafold).

Alternatively, if you cannot run Alphafold-2 locally, you can use a version of [Colabfold](https://github.com/sokrypton/ColabFold) that outputs the distance distributions. An implementation can be found [here](https://github.com/zshengyu14/ColabFold_distmats/blob/main/AlphaFold2.ipynb)

In the 0-inputs directory, you can find an Alphafold-2 (AF2) and a Colabfold prediction of PaaA2. 
To complete this tutorial, the user can in principle choose to use either a local Alphafold-2 or a Colabfold prediction.

### AF2

For Alphafold-2 predictions performed in a local cluster, the relevant information will be:

* The distograms. They are located in a pickle file whose name looks like `result_model_x_ptm_pred_x.pkl`

* The relaxed pdb model, which will be used as a starting point for the simulations.

### Colabfold

For Colabfold predictions, the necessary information will be the same.

* The distograms. In the implementation with the distograms [mentionned above](https://github.com/zshengyu14/ColabFold_distmats/blob/main/AlphaFold2.ipynb), they are located in a subdirectory that finishes with "_distmat" , in a numpy file whose name looks like `alphafold2_ptm_model_x_seed_xxx_prob_distributions.npy`

* The relaxed pdb model, which will be used as a starting point fot the simulations.


## 1. Preparation
**Working directory**: `1-preparation`

To generate the lammps files, we need the topology information of the protein and the force field. 
In our framework, this is done by converting gromacs files into lammps with a special python package. 
We therefore need to prepare GROMACS files at first:

The input of this step is the pdb model of the protein (which can be taken from Alphafold outputs).

In a terminal run:

`./step1-prepare_gmx.bash relaxed_model_4_ptm_pred_0.pdb`

This script runs gromacs commands that will take this pdb model and make GROMACS files out of it using the amber99SB-ILDN force field.
The outputs should contain `.gro`, `.itp`, `.top` and `.pdb` files.

## 2. Preprocessing
**Working directory**: `2-preprocessing`

In this step, the prediction outputs will be analyzed to generate the PLUMED files that are necessary for the bAIes simulations.

This is done with the python script `preprocess_bAIes.py`, which takes as inputs:

* The gromacs pdb model generated in the previous step. PLUMED needs to know the exact atom number of the atoms that will be selected for restraints, and some atom numbers are sometimes different between the AF2 and the gromacs outputs.

* The pdb model of Alphafold

* The distograms

In a terminal run the following:

`./step2-preprocess.bash idp.pdb relaxed_model_4_ptm_pred_0.pdb result_model_4_ptm_pred_0.pkl`

**Note:** Here, we use Alphafold-2 distograms.

If you want to use Colabfold information, an alternative command would look as follows:

`./step2-preprocess.bash idp.pdb relaxed_model_4_ptm_pred_0.pdb alphafold2_ptm_model_1_seed_000_prob_distributions.npy`

The script `step2-preprocess.bash` script runs the preprocessing program with the provided inputs. It will generate three files:

* `baies.dat`, which contains the atom numbers and parameters associated with each atom pair for which a force will be added by bAIes during the simulation

* `atom_list.ndx`, which contains a list of all the atoms involved in the bAIes restraints.

* `plumed.dat`, The PLUMED file to be given to the simulation inputs.

The `plumed.dat` file should look like this:

```#MOLINFO STRUCTURE=idp.pdb
batoms: GROUP NDX_FILE=atom_list.ndx NDX_GROUP=batoms
baies: BAIES ATOMS=batoms DATA_FILE=baies_params.dat PRIOR=JEFFREYS TEMP=2.478541306
PRINT ARG=baies.ene FILE=COLVAR STRIDE=500
bbias: BIASVALUE ARG=baies.ene STRIDE=2
```

## 3. Conversion to LAMMPS
**Working directory**: `3-conversion`

**Environment requirement**: In this step, it is important that you activate the baies environment before running `step3-conversion.bash`: `conda activate baies`. To obtain this environment, look at the software requirements.

In this step, the files generated in step 1 and 2 will be used to generate the final outputs for the bAIes simulation.

The inputs for this step are:

* The `.gro`, `.pdb` and `.top` files generated by GROMACS in the first step. They will be used for the conversion to LAMMPS.

* A file containing some additional force information for the final force field (`cmap_20240524.cmap`).

In a terminal, run:

`./step3-conversion.bash idp.gro idp.pdb idp.top`

This script does two things:

* First, it uses the python intermol library to convert the GROMACS files into LAMMPS files.

* Second, the `make_ff.py` script reads the LAMMPS and .cmap files and generates the final lammps inputs with the simplified force field.

The expected outputs are:

* A file ending with `_nvt.in` which is the LAMMPS input file. It contain all the basic information and settings for the LAMMPS simulations.

* A file ending with `_nvt.data` which contain force and topology information about the system. It is read by the LAMMPS input file.

## 4. Simulation
**Working directory**: `4-simulation`

In this step, we describe how to run bAIes simulations.

To run a simulation, we need to following in our directory:

* The LAMMPS input files containing the information about the system and the force field generated in step 3. They are composed by three files: `idp_nvt.in`, `idp_nvt.data` and `cmap_20240524.cmap`.

* The PLUMED input files generated in step 2: `plumed.dat`, `baies.dat` and `atom_list.ndx`.

* The `idp.pdb` file generated by GROMACS in step 1.

A bAIes simulation can be run in a terminal with the following command:

`lmp -in idp_nvt.in`

Of course, the LAMMPS input file `idp_nvt.in` can be modified to adjust the parameters of the simulation. Specifically, at the end of the file, some key lines can be adjusted to fit the purpose of the user:

* `dump 1 all xtc 10000 traj_idp.xtc`: This line states that LAMMPS will record every 10000 steps (10ps if the timestep is maintained at 1fs) and save it in an xtc file named `traj_idp.xtc`
* `run    2000000000`: This line specifies the number of steps to run for the simulation. In this example, 2G steps corresponds to 2 microseconds.

The xtc format is convenient because some simple tasks can be performed in one line in the terminal to perform some simple analysis with the GROMACS tool.
* To obtain some basic information about your trajectory, run `gmx check -f traj_idp.xtc`
* To keep only the structures every 100ps, run `gmx trjconv -f traj_idp.xtc -s idp.pdb -o traj_idp_dt100ps.xtc -dt 100`





